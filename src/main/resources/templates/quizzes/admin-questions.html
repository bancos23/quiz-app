<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" data-theme="dark">
<head th:replace="~{fragments :: commonHead(${'Manage Questions - ' + quiz.title})}"></head>

<body class="min-h-screen bg-base-200 flex items-start justify-center pt-10">

<div class="w-full max-w-3xl space-y-6">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class = "flex items-center gap-2 mb-2">
                <h1 class="card-title" id="quiz-title" th:text="${quiz.title}">Quiz Title</h1>
                <form th:action="@{|/admin/quizzes/${quiz.id}/toggle-publish|}" method="post" class="inline">
                    <button type="submit" id="publish-badge"
                            class="badge cursor-pointer hover:opacity-80 transition-opacity border-0"
                            th:classappend="${quiz.published} ? 'badge-success' : 'badge-warning'">
                        <span id="publish-text" th:text="${quiz.published} ? 'Published' : 'Draft'">Draft</span>
                    </button>
                </form>
            </div>
            <p class="opacity-90" id="quiz-description" th:text="${quiz.description}">Quiz description...</p>

            <div class="mt-3 flex justify-between items-center text-sm opacity-90">
                <span class="font-semibold">
                    Questions: <span id="question-count" th:text="${#lists.size(quiz.questions)}">0</span>
                </span>
                <a th:href="@{/admin/quizzes}" class="link link-hover">Back to quizzes list</a>
            </div>
        </div>
    </div>

    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title mb-3">Existing Questions</h2>

            <div id="no-questions-message" th:if="${#lists.isEmpty(quiz.questions)}" class="opacity-70">
                No questions yet. Add one below.
            </div>

            <ol id="questions-list" th:unless="${#lists.isEmpty(quiz.questions)}" class="list-decimal pl-5 space-y-2">
                <li th:each="q : ${quiz.questions}" th:id="'question-' + ${q.id}" class="question-item">
                    <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center">
                            <span>
                                <span class="font-medium question-text" th:text="${q.text}">Question text</span>
                                <span class="badge badge-outline ml-2 text-xs question-type"
                                      th:text="${q.displayType}">Single</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <a th:href="@{|/admin/quizzes/${quiz.id}/questions/${q.id}/options|}"
                                   class="btn btn-xs btn-outline">
                                    Manage options
                                </a>
                                <form th:action="@{|/admin/quizzes/${quiz.id}/questions/${q.id}/delete|}"
                                      method="post"
                                      onsubmit="return confirm('Delete this question?');">
                                    <button type="submit" class="btn btn-xs btn-error">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </li>
            </ol>

            <!-- Empty list container for when there are no questions initially -->
            <ol id="questions-list-empty" th:if="${#lists.isEmpty(quiz.questions)}" class="list-decimal pl-5 space-y-2 hidden">
            </ol>
        </div>
    </div>

    <!-- Add new question -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title mb-3">Add New Question</h2>

            <form th:action="@{|/admin/quizzes/${quiz.id}/questions|}"
                  th:object="${questionForm}"
                  method="post"
                  class="space-y-4">

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold text-base-content">Question text</span>
                    </label>
                    <textarea th:field="*{text}"
                              class="textarea textarea-bordered w-full"
                              rows="2"
                              placeholder="Enter question text"
                              required></textarea>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold text-base-content">Question type</span>
                    </label>
                    <select th:field="*{type}" class="select select-bordered w-full">
                        <option value="SINGLE_CHOICE">Single choice</option>
                        <option value="MULTIPLE_CHOICE">Multiple choice</option>
                    </select>
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="btn btn-primary">
                        Add Question
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<footer th:replace="~{fragments :: dockNav}"></footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    const quizId = /*[[${quiz.id}]]*/ 0;

    document.addEventListener('DOMContentLoaded', function() {
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable debug logs

        stompClient.connect({}, function(frame) {
            console.log('Connected to WebSocket');

            // Subscribe to quiz updates
            stompClient.subscribe('/topic/quiz/' + quizId, function(message) {
                const update = JSON.parse(message.body);
                handleQuizUpdate(update);
            });

            // Subscribe to question updates
            stompClient.subscribe('/topic/quiz/' + quizId + '/questions', function(message) {
                const update = JSON.parse(message.body);
                handleQuestionUpdate(update);
            });
        }, function(error) {
            console.error('WebSocket connection error:', error);
        });
    });

    function handleQuizUpdate(update) {
        if (update.type === 'QUIZ_PUBLISHED' || update.type === 'QUIZ_UPDATED') {
            const quiz = update.data;
            const badge = document.getElementById('publish-badge');
            const text = document.getElementById('publish-text');

            if (quiz.published) {
                badge.classList.remove('badge-warning');
                badge.classList.add('badge-success');
                text.textContent = 'Published';
            } else {
                badge.classList.remove('badge-success');
                badge.classList.add('badge-warning');
                text.textContent = 'Draft';
            }

            // Flash animation
            badge.classList.add('animate-pulse');
            setTimeout(() => badge.classList.remove('animate-pulse'), 1500);
        }
    }

    function handleQuestionUpdate(update) {
        switch(update.type) {
            case 'QUESTION_ADDED':
                addQuestionToList(update.data);
                break;
            case 'QUESTION_UPDATED':
                updateQuestionInList(update.data);
                break;
            case 'QUESTION_DELETED':
                removeQuestionFromList(update.questionId);
                break;
        }

        updateQuestionCount();
    }

    function addQuestionToList(question) {
        const questionsList = document.getElementById('questions-list') || document.getElementById('questions-list-empty');
        const noQuestionsMessage = document.getElementById('no-questions-message');

        // Check if question already exists
        if (document.getElementById('question-' + question.id)) return;

        // Hide "no questions" message and show list
        if (noQuestionsMessage) noQuestionsMessage.classList.add('hidden');
        questionsList.classList.remove('hidden');

        const questionHtml = createQuestionHtml(question);
        questionsList.insertAdjacentHTML('beforeend', questionHtml);

        // Flash animation
        const newQuestion = document.getElementById('question-' + question.id);
        newQuestion.classList.add('animate-pulse');
        setTimeout(() => newQuestion.classList.remove('animate-pulse'), 2000);
    }

    function updateQuestionInList(question) {
        const questionItem = document.getElementById('question-' + question.id);
        if (!questionItem) return;

        const textEl = questionItem.querySelector('.question-text');
        const typeEl = questionItem.querySelector('.question-type');

        if (textEl) textEl.textContent = question.text;
        if (typeEl) typeEl.textContent = question.displayType;

        // Flash animation
        questionItem.classList.add('animate-pulse');
        setTimeout(() => questionItem.classList.remove('animate-pulse'), 1500);
    }

    function removeQuestionFromList(questionId) {
        const questionItem = document.getElementById('question-' + questionId);
        if (questionItem) {
            questionItem.classList.add('opacity-50');
            setTimeout(() => {
                questionItem.remove();

                // Show "no questions" message if list is empty
                const questionsList = document.getElementById('questions-list');
                const noQuestionsMessage = document.getElementById('no-questions-message');
                if (questionsList && questionsList.children.length === 0 && noQuestionsMessage) {
                    noQuestionsMessage.classList.remove('hidden');
                }
            }, 300);
        }
    }

    function updateQuestionCount() {
        const countEl = document.getElementById('question-count');
        const questionsList = document.getElementById('questions-list');
        if (countEl && questionsList) {
            countEl.textContent = questionsList.querySelectorAll('.question-item').length;
        }
    }

    function createQuestionHtml(question) {
        return `
            <li id="question-${question.id}" class="question-item">
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between items-center">
                        <span>
                            <span class="font-medium question-text">${question.text}</span>
                            <span class="badge badge-outline ml-2 text-xs question-type">${question.displayType}</span>
                        </span>
                        <div class="flex items-center gap-2">
                            <a href="/admin/quizzes/${quizId}/questions/${question.id}/options"
                               class="btn btn-xs btn-outline">
                                Manage options
                            </a>
                            <form action="/admin/quizzes/${quizId}/questions/${question.id}/delete"
                                  method="post"
                                  onsubmit="return confirm('Delete this question?');">
                                <button type="submit" class="btn btn-xs btn-error">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </li>
        `;
    }
    /*]]>*/
</script>

</body>
</html>
